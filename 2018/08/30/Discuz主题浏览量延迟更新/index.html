
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>Discuz主题浏览量延迟更新 | 黄溜溜@PHP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="Tangchunxin">
    
    <meta name="description" content="帖子查看数及附件下载数延迟更新，可明显降低访问量很大的站点的服务器（主要针对 MySQL 的压力）负担，建议开启本功能。但对其中的程序流程和功能细节，可能有很多站长不是很清晰，在这里码点文字给大家串一串，希望在这个地方以后遇到问题，可以为大家提供一些思路。

一、如何开启延迟更新涉及的文件：sour">
    
    
    
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="黄溜溜@PHP" title="黄溜溜@PHP"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="黄溜溜@PHP">黄溜溜@PHP</a></h1>
				<h2 class="blog-motto">一个小小的PHP</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">主页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:tangchunxin.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2018/08/30/Discuz主题浏览量延迟更新/" title="Discuz主题浏览量延迟更新" itemprop="url">Discuz主题浏览量延迟更新</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://tangchunxin.com" title="Tangchunxin">Tangchunxin</a>
    </p>
  <p class="article-time">
    <time datetime="2018-08-30T05:56:27.000Z" itemprop="datePublished">2018-08-30</time>
    更新日期:<time datetime="2018-08-30T05:58:41.744Z" itemprop="dateModified">2018-08-30</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#一、如何开启延迟更新"><span class="toc-number">1.</span> <span class="toc-text">一、如何开启延迟更新</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#二、主题浏览量延迟更新的实际使用"><span class="toc-number">2.</span> <span class="toc-text">二、主题浏览量延迟更新的实际使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#三、附件下载量延迟更新的实际使用"><span class="toc-number">3.</span> <span class="toc-text">三、附件下载量延迟更新的实际使用</span></a></li></ol>
		</div>
		
		<blockquote>
<p>帖子查看数及附件下载数延迟更新，可明显降低访问量很大的站点的服务器（主要针对 MySQL 的压力）负担，建议开启本功能。但对其中的程序流程和功能细节，可能有很多站长不是很清晰，在这里码点文字给大家串一串，希望在这个地方以后遇到问题，可以为大家提供一些思路。</p>
</blockquote>
<h4 id="一、如何开启延迟更新"><a href="#一、如何开启延迟更新" class="headerlink" title="一、如何开启延迟更新"></a>一、如何开启延迟更新</h4><p>涉及的文件：source\admincp\admincp_setting.php<br>搜索关键字：delayviewcount</p>
<p>开启延迟更新在论坛后台的“全局 &#187; 优化设置 &#187; 服务器优化”中，按照需要在“点击数延迟更新”下勾选复选框就OK了，这个地方很简单。<br>在“点击数延迟更新”下有“主题浏览量”和“附件下载量”两项设置，但他们却是保存在同一个设置项目 delayviewcount 中的，所以这里从程序上做了点小处理。提交过来的两个选项，如果勾选其值即为1，不勾选其值即为0，将其拼接成二进制的字符，然后再将其转换为十进制后存到数据库中的。即为：<br>附件下载量关闭值为0，主题浏览量关闭值为0，拼接为二进制的数字为00，转换为十进制为0；<br>附件下载量关闭值为0，主题浏览量开启值为1，拼接为二进制的数字为01，转换为十进制为1；<br>附件下载量开启值为1，主题浏览量关闭值为0，拼接为二进制的数字为10，转换为十进制为2；<br>附件下载量开启值为1，主题浏览量开启值为1，拼接为二进制的数字为11，转换为十进制为3。<br>所以在数据表（pre_common_setting 表）中存储的值（skey = ‘delayviewcount’ 时，svalue 对应的值）即为0、1、2、3。</p>
<h4 id="二、主题浏览量延迟更新的实际使用"><a href="#二、主题浏览量延迟更新的实际使用" class="headerlink" title="二、主题浏览量延迟更新的实际使用"></a>二、主题浏览量延迟更新的实际使用</h4><p>涉及的文件：source\module\forum\forum_viewthread.php<br>搜索关键字：function viewthread_updateviews</p>
<p>涉及的文件：source\function\function_misc.php<br>搜索关键字：function updateviews</p>
<p>主题的浏览量即为查看数，在浏览一个主题时（访问 forum_viewthread.php 文件），则会给该主题的查看数加1，这个动作在 viewthread_updateviews 这个函数（forum_viewthread.php 文件的 695 行附近）中进行。如果没有开启延迟更新，则会直接在 pre_forum_thread 表的对应的主题记录中的 views 字段上加1。根据后台设置中的值（$_G[‘setting’][‘delayviewcount’] 的值，请参照上述对应值的开启关系）可以看出，值为1和3时均代表开启了主题浏览量的延迟更新，此时会进入延迟更新的流程。<br>延迟更新点击数会在 data/cache 目录下产生以 forum_threadviews 开头的 .log 文件，所以服务器上必须赋予这个目录可读可写的权限。每一个需要增加点击数的主题的 tid 都会写入这个文件中，并独自占一行，此时不会对 pre_forum_thread 表有任何写操作，达到延迟更新的目的。<br>当任意一个用户访问到主题浏览页（访问 forum_viewthread.php 文件）时，系统的时间戳的值的末尾两位为 00 时，便会触发将缓存的点击数一次性更新进数据库中。前面所讲的系统的时间戳如果大家不理解不要紧，就理解为 00 等于 100 秒，即每隔 100 秒就会触发一次更新，此处的 100 秒代表一个整点秒数的时间点，而不是时间间隔为 100 秒，所以触发更新必须在某一个时间点发生，而不是过 100 秒必定会发生一次更新。<br>举例：当前是午夜 00:00:00，100 秒之后是 00:01:40，则只有在 00:01:40 这一个时间点上有用户访问主题页面才会触发更新，如果刚巧没人访问则不会触发更新，便要等到下一个 100 秒后的时间点  00:03:20 的到来。<br>更新触发后，会调用 function_misc.php 文件中的 updateviews 函数（function_misc.php 文件的 299 行附近）执行批量的更新，将所有主题缓存的点击数一次性更新到数据库中。此过程需要 rename 函数的支持，所以要确保 data/cache 目录可读可写，并且在 PHP 的配置文件 php.ini 中不能禁止此函数，即 disable_functions 后面没有 rename 字样。</p>
<h4 id="三、附件下载量延迟更新的实际使用"><a href="#三、附件下载量延迟更新的实际使用" class="headerlink" title="三、附件下载量延迟更新的实际使用"></a>三、附件下载量延迟更新的实际使用</h4><p>涉及的文件：source\module\forum\forum_attachment.php<br>搜索关键字：updateviews</p>
<p>涉及的文件：source\function\function_misc.php<br>搜索关键字：function updateviews</p>
<p>附件下载量，在下载一个附件时（访问 forum_attachment.php 文件），则会给该附件的下载数加1，这个动作在 updateviews 这个函数执行的周围（forum_attachment.php 文件的 178 行附近）进行。如果没有开启延迟更新，则会直接在 pre_forum_attachment 表的对应的附件记录中的 downloads 字段上加1。根据后台设置中的值（$_G[‘setting’][‘delayviewcount’] 的值，请参照上述对应值的开启关系）可以看出，值为2和3时均代表开启了附件下载量的延迟更新，此时会进入延迟更新的流程。<br>延迟更新点击数会在 data/cache 目录下产生以 forum_attachviews 开头的 .log 文件，所以服务器上必须赋予这个目录可读可写的权限。每一个需要增加下载量的附件的 aid 都会写入这个文件中，并独自占一行，此时不会对 pre_forum_attachment 表有任何写操作，达到延迟更新的目的。<br>当任意一个用户下载附件（访问 forum_attachment.php 文件）时，系统的时间戳的值的末尾一位为 0 时，便会触发将缓存的下载量一次性更新进数据库中。前面所讲的系统的时间戳如果大家不理解不要紧，就理解为 0 等于 10 秒，即每隔 10 秒就会触发一次更新，此处的 10 秒代表一个整点秒数的时间点，而不是时间间隔为 10 秒，所以触发更新必须在某一个时间点发生，而不是过 10 秒必定会发生一次更新。<br>举例：当前是午夜 00:00:00，10 秒之后是 00:00:10，则只有在 00:00:10 这一个时间点上有用户去下载一个附件才会触发更新，如果刚巧没人下载则不会触发更新，便要等到下一个 10 秒后的时间点  00:00:20 的到来。<br>更新触发后，会调用 function_misc.php 文件中的 updateviews 函数（function_misc.php 文件的 299 行附近）执行批量的更新，将所有主题缓存的点击数一次性更新到数据库中。此过程需要 rename 函数的支持，所以要确保 data/cache 目录可读可写，并且在 PHP 的配置文件 php.ini 中不能禁止此函数，即 disable_functions 后面没有 rename 字样。</p>
  
	</div>
		<footer class="article-footer clearfix">




<div class="article-share" id="share">

  <div data-url="http://tangchunxin.com/2018/08/30/Discuz主题浏览量延迟更新/" data-title="Discuz主题浏览量延迟更新 | 黄溜溜@PHP" data-tsina="" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2018/09/21/抢购秒杀业务/" title="抢购秒杀业务">
  <strong>PREVIOUS:</strong><br/>
  <span>
  抢购秒杀业务</span>
</a>
</div>


<div class="next">
<a href="/2018/08/30/discuz-帖子评论/"  title="discuz 帖子评论">
 <strong>NEXT:</strong><br/> 
 <span>discuz 帖子评论
</span>
</a>
</div>

</nav>

	
</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#一、如何开启延迟更新"><span class="toc-number">1.</span> <span class="toc-text">一、如何开启延迟更新</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#二、主题浏览量延迟更新的实际使用"><span class="toc-number">2.</span> <span class="toc-text">二、主题浏览量延迟更新的实际使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#三、附件下载量延迟更新的实际使用"><span class="toc-number">3.</span> <span class="toc-text">三、附件下载量延迟更新的实际使用</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  

  

  <div class="rsspart">
	<a href="" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font clearfix">
		
		<a href="http://weibo.com/u/5908174541/home" target="_blank" title="weibo"></a>
		
		
		
		<a href="https://github.com/tangchunxin" target="_blank" title="github"></a>
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2019 
		
		<a href="http://tangchunxin.com" target="_blank" title="Tangchunxin">Tangchunxin</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://qr.liantu.com/api.php?text=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>






  </body>
</html>
